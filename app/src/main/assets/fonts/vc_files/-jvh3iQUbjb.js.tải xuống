;/*FB_PKG_DELIM*/

__d("EBAPIRetrierUtil",["EBAPISharedUtils","WALogger","WAPromiseBackoffs","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception thrown in EB retrier - exception message: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception thrown in EB retrier - exception message: ",""]);i=function(){return a};return a}var j={algo:{delay:1e4,type:"constant"}};a=function(){function a(a,b){this.$1=d("WAPromiseBackoffs").createPromiseTimer(j);this.$2=0;this.$3=a;this.$4=(a=b)!=null?a:function(){}}var c=a.prototype;c.run=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){while(this.$2<this.$3)if(this.$2===0)try{var c=(yield a(b));if(c.success)return c;else{var e=c.payload;e=(yield d("EBAPISharedUtils").handleDTSGTokenRotation(e));if(e==="token-rotation-not-required")return c;if(e==="token-rotation-failed"){this.$4("dtsg-token-rotation-failed");return c}e;this.$4("dtsg-token-rotation-successful")}}catch(a){d("WALogger").ERROR(i(),(c=a.message)!=null?c:"")}finally{this.$2++}else if(this.$2<this.$3){e=d("WAResultOrError").makeError("max-attempts-exceeded");try{yield this.$1();e=(yield a(b));if(e.success)return e}catch(a){d("WALogger").ERROR(h(),(c=a.message)!=null?c:"")}finally{this.$2++}if(this.$2===this.$3){this.$4("dtsg-retrier-max-attempts-exceeded");return e}}return d("WAResultOrError").makeError("max-attempts-exceeded")});function c(b,c){return a.apply(this,arguments)}return c}();return a}();g.BACKOFF_OPTIONS=j;g.EBAPIRetrier=a}),98);
__d("EBParseUploadSerializationPayload",["WAErrorMessage","WAResultOrError","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseUploadSerializationResponse: ",""]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS(["parseUploadSerializationResponse"]);function a(a){try{a=JSON.parse(a);return d("WAResultOrError").makeResult(a)}catch(b){a=d("WAErrorMessage").maybeGetMessageFromError(b);i.ERROR(h(),a);return d("WAResultOrError").makeError("parse_exception")}}g.parseUploadSerializationResponse=a}),98);
__d("EBUploadMessagesFromWorkerMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9723960407697513"}),null);
__d("EBUploadMessagesFromWorkerMutation.graphql",["EBUploadMessagesFromWorkerMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],c=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTUploadMessageGQLResponse",kind:"LinkedField",name:"xfb_upload_encrypted_msg_to_backup",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"device_epoch_status",storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageHandlerResponse",kind:"LinkedField",name:"backup_write_result_response",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"delete_mailbox",storageKey:null},{alias:null,args:null,concreteType:"XFBTProtobufParams",kind:"LinkedField",name:"protobuf_params",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"delete_on_success",storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"EBUploadMessagesFromWorkerMutation",selections:c,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"EBUploadMessagesFromWorkerMutation",selections:c},params:{id:b("EBUploadMessagesFromWorkerMutation_facebookRelayOperation"),metadata:{},name:"EBUploadMessagesFromWorkerMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("LSHandleBackupWriteCompletion",["EBEnableUnifiedAttachment","LSVec","MAWEBFrontendQPLLogger","Promise","asyncToGeneratorRuntime","cr:847"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){if(g!=null){e=c("LSVec").toArray(g);d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&e.forEach(function(a){return d("MAWEBFrontendQPLLogger").endFlowUploadAttachmentBackup(a,f,"unified")})}if(b("cr:847")!=null){e=g!=null?c("LSVec").toArray(g):[];e.length>0&&(yield b("cr:847")(a,e))}return(h||(h=b("Promise"))).resolve()});return i.apply(this,arguments)}g.call=a}),98);
__d("LSHandleBackupWriteCompletion.nop",["LSHandleBackupWriteCompletion"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,e){return d("LSHandleBackupWriteCompletion").call(a,b,c,e)};a.__nop_name__="LSHandleBackupWriteCompletion";g["default"]=a}),98);
__d("LSMarkBackupAsCompleted.nop",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(a,c,d,e,f,h,i){return(g||(g=b("Promise"))).resolve()};a.__nop_name__="LSMarkBackupAsCompleted";f["default"]=a}),66);
__d("LSHandleProtobufWriteResult",["LSArrayGetObjectAt","LSMarkBackupAsCompleted.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return a[3]?d[0]=!1:d[0]=!0,d[0]?c.resolve():(d[1]=a[3].get("delete_on_success"),d[1]&&a[0]&&!a[1]?(a[2]?d[2]=!1:d[2]=!0,d[2]?c.resolve():c.sequence([function(e){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.of_int32(a[2].length),c.i64.gt(d[4],c.i64.cast([0,0]))?c.loopAsync(d[4],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,d){var e=a.done;a=a.value;return e?0:(d=a.item,c.nativeOperation(b("LSMarkBackupAsCompleted.nop"),d.actThreadId,d.toplevelOfflineThreadingId,d.supplementalKey,d.messageTimestampMs,d.backupAction))})}])}):c.resolve()},function(e){return d[5]=c.i64.of_int32(a[2].length),c.i64.gt(d[5],c.i64.cast([0,0]))?c.loopAsync(d[5],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var e=a.done;a=a.value;return e?0:(b=a.item,d[12]=b.actThreadId,d[13]=b.toplevelOfflineThreadingId,d[11]=b.supplementalKey,d[14]=b.messageTimestampMs,d[11]!==void 0?c.forEach(c.filter(c.db.table(302).fetch(),function(a){return a.threadId===d[12]&&a.toplevelOfflineThreadingId===d[13]&&a.supplementalKey===d[11]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}):c.forEach(c.filter(c.db.table(301).fetch(),function(a){return a.threadId===d[12]&&a.offlineThreadingId===d[13]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}))})}])}):c.resolve()},function(e){return d[6]=c.i64.of_int32(a[2].length),c.i64.gt(d[6],c.i64.cast([0,0]))?c.loopAsync(d[6],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var d=a.done;a=a.value;return d?0:(b=a.item,c.forEach(c.db.table(304).fetch([[[b.toplevelOfflineThreadingId,b.actThreadId]],"offlineThreadingId"]),function(a){return a["delete"]()}))})}])}):c.resolve()}])):c.resolve())},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleProtobufWriteResultStoredProcedure";a.__tables__=["pending_protobuf_backups_context","local_message_persistence_store_supplemental","local_message_persistence_store","local_message_persistence_store_tag_index"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2",["LSArrayGetObjectAt","LSDeleteBackupOnClient","LSHandleBackupWriteCompletion.nop","LSHandleProtobufWriteResult","LSLogMEBUploadSuccessEvent.nop","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Beginning execution."),d[1]=c.createArray(),d[2]=c.createArray(),a[3]?d[3]=!1:d[3]=!0,d[3]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(e){return c.db.table(177).fetch([[[d[14]]],"fk_pending_tasks"]).next().then(function(e,f){var g=e.done;e=e.value;return g?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Pending backup task id not found!"),d[18]="Pending backup task id not found!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ","",d[18]].join("")),d[17]=c.createArray(),void 0!==void 0?d[19]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",d[18],d[17],c.i64.cast([0,3]))):(f=e.item,c.sequence([function(d){return c.i64.eq(f.contentType,c.i64.cast([0,1]))?c.nativeOperation(b("LSLogMEBUploadSuccessEvent.nop"),f.uniqueKey,f.lsTraceId,a[1]):c.resolve()},function(a){return d[17]=(d[2].push(f.persistentId),d[2])}]))})}])}):c.resolve())},function(d){return c.storedProcedure(b("LSHandleProtobufWriteResult"),a[1],a[2],a[3],a[4],!1)},function(e){return d[4]=c.i64.of_float(Date.now()),a[3]?d[5]=!1:d[5]=!0,d[5]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[14])}),function(a){return a["delete"]()})}])}):c.resolve())},function(e){return a[2]?c.sequence([function(e){return d[12]=c.i64.of_int32(a[0].length),c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],c.i64.cast([0,0])).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return d[13]=d[14]}])},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[13],void 0,!0)}]):c.resolve()},function(e){return c.nativeOperation(b("LSHandleBackupWriteCompletion.nop"),a[1],a[0],d[2])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure";a.__tables__=["pending_backups_context_v2","pending_protobuf_backups_context"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2StoredProcedure",["LSHandleBackupWriteResultV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSHandleBackupWriteResultV2"),e.traceIds,e.isSuccess,e.deleteMailbox,e.taskIds,e.protobufParams);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSPrepareOpenEpochV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Beginning execution."),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50005"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="320"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(a){return d[1]||d[3]?c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Skipping openEpoch start because there is already an openEpoch flow in progress."),d[5]=c.i64.cast([0,1]))):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1441]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[18]=new c.Map(),d[18].set("error_msg","Expected a nonempty query result"),d[18].set("code",c.i64.cast([0,3])),d[18].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[19]=c.createArray(),d[20]=(d[19].push(d[18]),d[19]),e=[void 0,d[19]],d[12]=e[0],d[13]=e[1],e):(b=a.item,d[18]=new c.Map(),d[18].set("backup_id",b.backupId),d[18].set("device_public_key_blob",b.devicePublicKeyBlob),d[18].set("device_private_key_blob",b.devicePrivateKeyBlob),d[18].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[18].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[18].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[18].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[18].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[18].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[18].set("orf_client_state_v2_blob",void 0),d[18].set("orf_v2_authority_level",void 0),d[18].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[18].set("device_id",b.deviceId),d[18].set("backup_tenancy",b.backupTenancy),d[18].set("encryption_version",b.encryptionVersion),d[18].set("revision_version",b.revisionVersion),d[18].set("initialize_restore_result",void 0),d[18].set("device_creation_timestamp_sec",void 0),d[18].set("authority_level",b.authorityLevel),e=[d[18],void 0],d[12]=e[0],d[13]=e[1],e)})},function(a){return d[15]=new c.Map(),d[15].set("value",d[12]),d[15].set("errors",d[13]),d[16]=d[15].get("value"),d[16]!==void 0?c.sequence([function(a){return d[18]=d[16].get("backup_id"),d[19]=d[16].get("device_public_key_blob"),d[20]=d[16].get("device_private_key_blob"),d[21]=d[16].get("epoch_storage_public_key_blob"),d[22]=d[16].get("epoch_storage_private_key_blob"),d[23]=d[16].get("epoch_auth_public_key_blob"),d[24]=d[16].get("epoch_auth_private_key_blob"),d[25]=d[16].get("mailbox_root_key_blob"),d[26]=d[16].get("ocmf_client_state_blob"),d[27]=d[16].get("orf_client_state_v2_blob"),d[28]=d[16].get("orf_v2_authority_level"),d[29]=d[16].get("oblivious_validation_token_blob"),d[30]=d[16].get("device_id"),d[31]=d[16].get("backup_tenancy"),d[32]=d[16].get("encryption_version"),d[33]=d[16].get("revision_version"),d[34]=d[16].get("initialize_restore_result"),d[35]=d[16].get("device_creation_timestamp_sec"),d[36]=d[16].get("authority_level"),c.i64.neq(d[30],void 0)?c.sequence([function(a){return d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[50]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[60]=(d[50].push(c.i64.cast([0,0])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[60]=(d[50].push(c.i64.cast([0,2])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]?d[60]=(d[50].push(c.i64.cast([0,3])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[60]=(d[50].push(c.i64.cast([0,4])),d[50]):0,d[55]=c.createArray(),d[56]=c.i64.of_int32(d[50].length),c.i64.gt(d[56],c.i64.cast([0,0]))?c.loopAsync(d[56],function(a){return d[60]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[50],d[60]).then(function(a){return a=a,d[61]=a[0],d[62]=a[1],a})},function(a){return d[63]=(d[55].push(d[61]),d[55])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[60]=c.createArray(),d[61]=c.i64.of_int32(d[55].length),c.i64.gt(d[61],c.i64.cast([0,0]))?c.loopAsync(d[61],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[55],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[60].push(c.i64.to_string(d[64])),d[60])}])}):c.resolve()},function(a){return d[62]=d[60].join(","),d[57]=d[62]}])},function(a){return d[55].some(function(a){return c.i64.eq(d[32],a)})?d[58]=d[32]:d[58]=void 0,c.i64.neq(d[58],void 0)?d[59]=d[58]:d[59]=void 0,d[39]=d[59]}])},function(a){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[31],void 0)?d[41]=d[31]:d[41]=c.i64.cast([0,1]),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2821]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[50]=(d[42].push(a.epochId),d[42])})},function(a){return d[48]="Queried locally available epochs. Count: ",d[43]=c.i64.of_int32(d[42].length),d[49]=c.i64.to_string(d[43]),d[44]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[44],d[48],d[44],d[49]].join("")),c.resolve()},function(a){return d[45]=new c.Map(),d[45].set("backup_id",d[18]),d[45].set("locally_available_epochs",d[42]),d[45].set("device_id",d[30]),d[45].set("trace_id",void 0),d[46]=c.toJSON(d[45]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_request_for_asssoc_devices",c.i64.cast([0,50005]),d[46],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1442]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[37]=c.i64.cast([0,0])}]):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[39]?d[40]=!0:d[40]=!1,d[40]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[42]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[42]].join("")),d[41]=c.createArray(),void 0!==void 0?d[43]=(d[41].push(void 0),d[41]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[42],d[41],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[38]="No backup found.",d[38]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[38]].join("")),d[39]=c.createArray(),void 0!==void 0?d[40]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[38],d[39],c.i64.cast([0,3]))):c.resolve()},function(a){return d[37]=c.i64.cast([0,1])}])},function(a){return d[17]=d[37]}]):c.sequence([function(a){return d[18]=d[15].get("errors"),d[19]=d[15].get("errors"),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[24]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[24]].join("")),d[23]=c.createArray(),void 0!==void 0?d[25]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[24],d[23],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[20]="No backup found.",d[20]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[20]].join("")),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[20],d[21],c.i64.cast([0,3]))):c.resolve()},function(a){return d[17]=c.i64.cast([0,1])}])},function(a){return d[5]=d[17]}])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[5]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure";a.__tables__=["pending_tasks","secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSPrepareOpenEpochV2StoredProcedure",["LSPrepareOpenEpochV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){e===void 0&&(e={});a=a.storedProcedure(c("LSPrepareOpenEpochV2"),e.backupId,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSSyncEpochs",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] Beginning execution."),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1436]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[14]=!0:d[14]=!1,d[14]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[16]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[16]].join("")),d[15]=c.createArray(),void 0!==void 0?d[17]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[16],d[15],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:247 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1],e):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1],e)})},function(a){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(a){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[41]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[51]=(d[41].push(c.i64.cast([0,0])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[51]=(d[41].push(c.i64.cast([0,2])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[51]=(d[41].push(c.i64.cast([0,3])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[51]=(d[41].push(c.i64.cast([0,4])),d[41]):0,d[46]=c.createArray(),d[47]=c.i64.of_int32(d[41].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[46].push(d[52]),d[46])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[51].push(c.i64.to_string(d[55])),d[51])}])}):c.resolve()},function(a){return d[53]=d[51].join(","),d[48]=d[53]}])},function(a){return d[46].some(function(a){return c.i64.eq(d[27],a)})?d[49]=d[27]:d[49]=void 0,c.i64.neq(d[49],void 0)?d[50]=d[49]:d[50]=void 0,d[34]=d[50]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50013"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[37]=!1:(a.item,d[37]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="50025"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[39]=!1:(a.item,d[39]=!0)})},function(a){return d[37]||d[39]?(d[41]="Another sync job is already in progress. Terminating this.",d[41]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[41]].join("")),d[42]=c.createArray(),void 0!==void 0?d[43]=(d[42].push(void 0),d[42]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[41],d[42],c.i64.cast([0,3]))):c.resolve()):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2849]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[50]=!0:d[50]=!1,d[50]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[52]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[52]].join("")),d[51]=c.createArray(),void 0!==void 0?d[53]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[52],d[51],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[49]=(d[41].push(a.epochId),d[41])})},function(a){return d[47]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[48]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[47],d[43],d[48]].join("")),c.resolve()},function(a){return d[44]=new c.Map(),d[44].set("backup_id",d[13]),d[44].set("device_id",d[25]),d[44].set("locally_available_epochs",d[41]),d[44].set("trace_id",void 0),d[45]=c.toJSON(d[44]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",c.i64.cast([0,50025]),d[45],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})}])},function(a){return d[32]=!0}]):c.sequence([function(a){return d[33]=["Failed to load client state: ","","NULL_DEVICE_ID"].join(""),d[33]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[33]].join("")),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[33],d[34],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(a){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=["Failed to load client state: ","","BACKUP_NOT_FOUND"].join(""),d[15]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[15]].join("")),d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[15],d[16],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSyncEpochsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_tasks","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSSyncEpochsStoredProcedure",["LSSyncEpochs","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a){a=a.storedProcedure(c("LSSyncEpochs"));return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSBackupContentType",[],(function(a,b,c,d,e,f){a=Object.freeze({MESSAGE:1,THREAD:2});f["default"]=a}),66);
__d("LSPendingBackupStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({NEEDS_BACKUP:1,BACKUP_IN_PROGRESS:2,BLOCKED:3});f["default"]=a}),66);
__d("LSSerializeAttachmentBackupPayloadStoredProcedure",["LSSerializeAttachmentBackupPayload","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSSerializeAttachmentBackupPayload"),e.attachmentInfos,e.messageId,e.threadId,e.productType,e.error,e.errorMessage);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWUploadPayloadGenerator",["EBParseUploadSerializationPayload","FBLogger","I64","LSBackupContentType","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSPendingBackupStatus","LSSerializeAttachmentBackupPayloadStoredProcedure","LSShape","LSTaskSerializerEncryptedBackupsUpload","MAWBridgeUploadMessageHandler","MAWEBFrontendQPLLogger","MWEBODSUtils","Promise","Random","ReQL","WAGetSafeQPLError","WATagsLogger","asyncToGeneratorRuntime","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload message is missing echo document msgType: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB upload serializer error: "," in ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB upload serializer error: "," in ",""]);m=function(){return a};return a}var n=d("WATagsLogger").TAGS(["labyrinth_web","MAWUploadPayloadGenerator"]),o="0",p=new Set();function q(){for(var a=0;a<1e8;a++){var b=d("Random").uint32();if(!p.has(b))return b}throw c("FBLogger")("messenger_web").mustfixThrow("Unable to generate a unique task ID after 100 million attempts")}function a(a,b,c){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){var g="unknown";c("justknobx")._("4439")&&(g=(yield y(a))?"available":"unavailable");e=e.map(function(b){var c=q();p.add(c);return s(a,b,c)});e=(yield (j||(j=b("Promise"))).all(e));e=(yield j.all(e.map(function(e){var i;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((i=e.uploadTrackingInstanceKey)!=null?i:null,"upload_task_serialization_start",{string:{base_epoch_availability:g,execution_environment:f}});return c("LSTaskSerializerEncryptedBackupsUpload")((h||(h=d("I64"))).of_int32(e.task),c("LSFactory")(a)).then(function(c){if(c.length>0&&c[0]!=null){var g=d("EBParseUploadSerializationPayload").parseUploadSerializationResponse(c[0]);if(g.success)if(g.value.failure!=null){var h=g.value.failure.error_code+": "+g.value.failure.error_message;n.ERROR(m(),h,f);if(e.uploadTrackingInstanceKey!=null){d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_task_serialization_failure",{"int":{serialization_error_code:(h=(h=g.value)==null?void 0:(h=h.failure)==null?void 0:h.error_code)!=null?h:0},string:{serialization_error:g.value.failure.error_message}})}}else{d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((h=e.uploadTrackingInstanceKey)!=null?h:null,"upload_task_serialization_success",{string:{execution_environment:f}})}}g=e.pending_protobuf_backups_context_pk;return(j||(j=b("Promise"))).all([a.pending_backups_context_v2["delete"](e.pending_backups_context_v2_pk),g!=null?a.pending_protobuf_backups_context["delete"](g):(j||(j=b("Promise"))).resolve(null)]).then(function(){p["delete"](e.task);return c})})["catch"](function(a){var b;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((b=e.uploadTrackingInstanceKey)!=null?b:null,"upload_task_serialization_failure",{string:{serialization_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});n.ERROR(l(),d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),f);throw a})})));e=(yield j.all(e.map(function(a){return a[0]})));return e});return r.apply(this,arguments)}function s(a,b,c){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=b.sortOrderMs.toString(),g=(h||(h=d("I64"))).of_int32(e),j=h.of_float(b.actionType),l=(yield v(a,b)),m=b.protoMsg,o=m!=null&&c("gkx")("8488");if(!o&&(b.echoDocument==null||b.echoDocument.length===0)){var p;n.ERROR(k(),(p=b.messageType)!=null?p:"unknown");d("MWEBODSUtils").markODSForEB("upload","missing_echo_document."+((p=b.messageType)!=null?p:"unknown"))}j=(yield a.pending_backups_context_v2.add({actionType:j,attachmentErrorCode:x(b),attachmentPayload:l,backupStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSPendingBackupStatus").BACKUP_IN_PROGRESS),contentType:i.ofNumber(c("LSBackupContentType").MESSAGE),echoContent:o?"":(p=b.echoDocument)!=null?p:"",listKey:b.threadId,pendingBackupTaskId:h.of_int32(e),persistentId:"",pk:g,sortKey:f,uniqueKey:b.messageId}));if(m==null)return{pending_backups_context_v2_pk:j[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey};g=(yield a.pending_protobuf_backups_context.add({actThreadId:b.threadId,attachmentPayload:l,backupAction:h.of_float(m.backupActionType),messageTimestampMs:h.of_float(b.sortOrderMs),pendingBackupTaskId:h.of_float(e),supplementalKey:m.supplementalKey,toplevelOfflineThreadingId:m.backupActionType===4?m.msgId.externalId:(p=(o=m.originalMsgProtocolId)==null?void 0:o.externalId)!=null?p:m.msgId.externalId}));return{pending_backups_context_v2_pk:j[0],pending_protobuf_backups_context_pk:g[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey}});return t.apply(this,arguments)}function u(a){if(a.attachmentInfos.length!==1)return[];a=a.attachmentInfos[0];return[{attachment_trace_id:a.attachmentTraceId,media_type:a.mediaType,zippy_object_id:a.zippyObjectId}]}function v(a,b){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(!c("gkx")("6956"))return void 0;var e,f,g=b.attachmentBackupContext;if(g!=null){f=d("MAWBridgeUploadMessageHandler").getMessageUploadAttachmentBackupContext({bridgeUploadAttachmentBackupContext:g,messageId:b.messageId,serverThreadKey:null,threadId:b.threadId,traceId:b.traceId});if(f!=null){a=(yield c("LSSerializeAttachmentBackupPayloadStoredProcedure")(c("LSFactory")(a),{attachmentInfos:f.attachment_infos,error:f.error,errorMessage:f.error_message,messageId:b.messageId,productType:f.product_type,threadId:b.threadId}));f=a[0];b=a[1];if(f!=null){a=d("LSShape").toRecord(f);e=JSON.stringify({success:a.payload,upload_context:u(g)})}else if(b!=null){f=d("LSShape").toRecord(b);a=f.error_code;e=JSON.stringify({failure:{error_code:(h||(h=d("I64"))).to_float(a),error_message:f.error_message,stored_procedure:f.stored_procedure},upload_context:u(g)})}}}return e});return w.apply(this,arguments)}function x(a){return!c("gkx")("6956")?void 0:(h||(h=d("I64"))).of_float(((a=a.attachmentBackupContext)==null?void 0:a.error)!=null?c("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR:c("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR)}function y(a){var b=new TextDecoder();return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_epochs).filter(function(a){return b.decode(a.epochAnonIdBlob)===o})).then(function(a){if(a!=null)return!0;else return!1})}g.genUploadPayload=a}),98);
__d("XFBEBDeviceEpochStatus.facebook",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum").Mirrored(["INELIGIBLE_FOR_LABYRINTH_11","NO_OPEN_EPOCH","OK","OUTDATED","RATE_LIMITED"]);c=a;f["default"]=c}),66);
__d("EBUploadMessagesFromWorkerMutation",["EBIsEbEnabled","EBLS","EBUploadMessagesFromWorkerMutation.graphql","EncryptedBackupsWriteToMPSTables","FBLogger","LSFactory","LSHandleBackupWriteResultV2StoredProcedure","LSPrepareOpenEpochV2StoredProcedure","LSShape","LSSyncEpochsStoredProcedure","LSVec","MAWCurrentUser","MAWEBFalcoLoggerUtils","MAWEBUploadTrackingUtils","MAWUploadPayloadGenerator","Promise","WAErrorMessage","WALogger","WAResultOrError","asyncToGeneratorRuntime","createWorkerMutation"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to upload with EBLS: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphqlResponse is null"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to generate payload: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backupWriteResult is null"]);m=function(){return a};return a}var n=h!==void 0?h:h=b("EBUploadMessagesFromWorkerMutation.graphql");function o(a,b){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a.uploadTrackingInstanceKey,b)})}function p(a,b,c){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a.uploadTrackingInstanceKey,b,c)})}function q(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.backupWriteResult,e=a.deviceEpochStatus,g=a.exception_string,h=a.inputMessages;if(b==null){p(h,"ebls_upload_failed_backup_write_result_null",{string:{error:"backupWriteResult is null"}});d("WALogger").ERROR(m());return d("WAResultOrError").makeError("backup_write_result_null")}a=(yield d("EBLS").getLSStorage());var i=b.is_success,j=b.delete_mailbox,k=(b=b.protobuf_params)==null?void 0:b.delete_on_success;if(i!=null&&j!=null){if(!i){p(h,"ebls_upload_failed",{string:{error:g}});return d("WAResultOrError").makeError("gql_upload_failed")}else c("FBLogger")("labyrinth_web").info("Worker successfully completed GQL upload batch of size %s",h.length),o(h,"ebls_upload_success");yield a.runInTransaction(function(a){return c("LSHandleBackupWriteResultV2StoredProcedure")(c("LSFactory")(a),{deleteMailbox:j,isSuccess:i,protobufParams:k!=null?d("LSShape").ofRecord({delete_on_success:k}):void 0,traceIds:c("LSVec").ofArray(h.map(function(a){return a.traceId}))})},"readwrite",void 0,void 0,f.id+":153")}if(e==null)return d("WAResultOrError").makeError("device_epoch_status_null");switch(e){case"NO_OPEN_EPOCH":o(h,"prepare_open_epoch_v2_start");yield a.runInTransaction(function(a){return c("LSPrepareOpenEpochV2StoredProcedure")(c("LSFactory")(a),{backupId:void 0})},"readwrite",void 0,void 0,f.id+":177");o(h,"prepare_open_epoch_v2_end");break;case"OUTDATED":o(h,"sync_epochs_start");yield a.runInTransaction(function(a){return c("LSSyncEpochsStoredProcedure")(c("LSFactory")(a))},"readonly",void 0,void 0,f.id+":188");o(h,"sync_epochs_start");break;case"OK":break;default:}return d("WAResultOrError").makeResult()});return r.apply(this,arguments)}function a(a){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{o(a,"ebls_init_start");yield d("EBLS").init();var e=(yield d("EBLS").getLSStorage());o(a,"ebls_backup_tenancy_start");if(!(yield d("EBIsEbEnabled").isEbEnabledLS(e.tables))){for(var g of a)if(g.uploadTrackingInstanceKey!=null){var h=g.uploadTrackingInstanceKey;d("MAWEBUploadTrackingUtils").addPointWorkerOnly(h,"user_device_not_enrolled_invalid_gql_request");var m=g.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskSkipped(g,m,"user_device_not_enrolled");d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(h,"upload_tracking_completed")}return d("WAResultOrError").makeError("ebls_not_initialized")}o(a,"ebls_upload_start");m=[];try{m=(yield e.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){o(a,"ebls_lsdb_write_start");yield (i||(i=b("Promise"))).all(a.map(function(a){return a.protoMsg?[a.protoMsg,a.threadId,a.uploadTrackingInstanceKey]:null}).filter(Boolean).map(function(a){var e=a[0],f=a[1];a=a[2];a=a!=null?d("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(a):null;return e.backupActionType===1?(i||(i=b("Promise"))).all([d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(c,e,f,!1,a),d("EncryptedBackupsWriteToMPSTables").writeTagsToMPSTables(c,e,f)]):d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(c,e,f,!1,a)}));o(a,"ebls_mps_write_complete");return d("MAWUploadPayloadGenerator").genUploadPayload(c,a,"worker")});return function(a){return c.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":236")),o(a,"ebls_upload_payload_generated")}catch(b){h=d("WAErrorMessage").maybeGetMessageFromError(b);p(a,"ebls_upload_failed_payload",{string:{error:h}});d("WALogger").ERROR(l(),h);return d("WAResultOrError").makeError("upload_serialization_failure")}if(m.length===0){p(a,"ebls_upload_payload_empty");return d("WAResultOrError").makeResult()}a.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskIssued(b,a)});g=c("createWorkerMutation")(n);e=g[0];h=(yield e({input:{app_id_str:d("MAWCurrentUser").getAppID(),payload:{msg_payloads:m.filter(Boolean)}}}));o(a,"ebls_received_gql_upload_response");if(h==null){p(a,"ebls_upload_failed_response_null");d("WALogger").ERROR(k());a.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,"ebls_not_initialized")});return d("WAResultOrError").makeError("gql_upload_null_response")}e=(g=h.xfb_upload_encrypted_msg_to_backup)!=null?g:{};m=e.backup_write_result_response;h=e.device_epoch_status;g=e.exception_string;var r=(yield q({backupWriteResult:m,deviceEpochStatus:h,exception_string:g,inputMessages:a}));!r.success?a.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,r.error)}):a.forEach(function(a){d("MAWEBFalcoLoggerUtils").logEBFalcoEncryptedBackupUploadSuccess(a)});return r}catch(b){e=d("WAErrorMessage").maybeGetMessageFromError(b);p(a,"ebls_upload_failed_response",{string:{error:e}});a.forEach(function(a){var b=a.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(a,b,"ebls_not_initialized")});d("WALogger").ERROR(j(),b);return d("WAResultOrError").makeError("gql_upload_runtime_error")}});return s.apply(this,arguments)}g.uploadMessagesFromWorker=a}),98);
__d("MAWEncryptedBackupsMessageUploadMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9801171086601862"}),null);
__d("MAWEncryptedBackupsMessageUploadMutation.graphql",["MAWEncryptedBackupsMessageUploadMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],c={alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null};c=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTUploadMessageGQLResponse",kind:"LinkedField",name:"xfb_upload_encrypted_msg_to_backup",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"device_epoch_status",storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageHandlerResponse",kind:"LinkedField",name:"backup_write_result_response",plural:!1,selections:[c,{alias:null,args:null,kind:"ScalarField",name:"delete_mailbox",storageKey:null},{alias:null,args:null,concreteType:"XFBTProtobufParams",kind:"LinkedField",name:"protobuf_params",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"delete_on_success",storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageGQLResponseLabyrinth11",kind:"LinkedField",name:"labyrinth_1_1",plural:!1,selections:[c],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"MAWEncryptedBackupsMessageUploadMutation",selections:c,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"MAWEncryptedBackupsMessageUploadMutation",selections:c},params:{id:b("MAWEncryptedBackupsMessageUploadMutation_facebookRelayOperation"),metadata:{},name:"MAWEncryptedBackupsMessageUploadMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("MAWEncryptedBackupsMessageUploadMutation",["CometRelay","CometRelayEnvironment","CurrentAppID","EBAPIRetrierUtil","LSFactory","LSHandleBackupWriteResultV2StoredProcedure","LSPrepareOpenEpochV2StoredProcedure","LSShape","LSSyncEpochsStoredProcedure","LSVec","MAWEBFrontendQPLLogger","MAWEncryptedBackupsMessageUploadMutation.graphql","MAWUploadPayloadGenerator","MWEBODSUtils","Promise","WALogger","WAResultOrError","asyncToGeneratorRuntime","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backupWriteResult is null"]);j=function(){return a};return a}var k=c("justknobx")._("3992"),l=h!==void 0?h:h=b("MAWEncryptedBackupsMessageUploadMutation.graphql");function m(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.environment,c=a.uploadMessages;a=a.uploadMsgMutationData;try{b=(yield r(b,c,a));return d("WAResultOrError").makeResult(b)}catch(a){return a instanceof Error?d("WAResultOrError").DEPRECATED_makeError(void 0,a):d("WAResultOrError").makeError()}});return n.apply(this,arguments)}function o(a,b,c){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=new(d("EBAPIRetrierUtil").EBAPIRetrier)(k,function(a){return t(c,a)});e=(yield e.run(m,{environment:b,uploadMessages:c,uploadMsgMutationData:a}));if(e.success)return e.value;e.payload instanceof Error?q(e.payload.message,c):q("gql_upload_retrier_unknown_error",c)});return p.apply(this,arguments)}function q(a,b){u(b,"gql_upload_failed_on_commit_upload",{string:{error:(b=a)!=null?b:"runtime exception thrown when committing upload mutation"}})}function r(a,e,f){return new(i||(i=b("Promise")))(function(b,g){var h=function(a){c("gkx")("11805")||q(a.message,e),g(a)};d("CometRelay").commitMutation(a,{mutation:l,onCompleted:b,onError:h,variables:{input:f}})})}function s(a,b,d){return c("gkx")("11805")?o(a,b,d):r(b,d,a)["catch"](function(a){u(d,"gql_upload_failed_while_committing_mutation",{string:{error:(a=a.message)!=null?a:"runtime exception thrown when committing upload mutation"}})})}function t(a,b,c){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(a.uploadTrackingInstanceKey,b,c)})}function u(a,b,c){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").failEBUploadTracking(a.uploadTrackingInstanceKey,b,c)})}function a(a,b){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var g=(yield a.runInTransaction(function(a){return d("MAWUploadPayloadGenerator").genUploadPayload(a,e,"main-thread")},"readwrite",void 0,void 0,f.id+":270")),h={bool:{is_main_thread:!0},"int":{batch_size:e.length},string:{batch_bucket:d("MWEBODSUtils").getBucketName(e.length)}};t(e,"gql_upload_network_request_start",h);var i=(yield s({app_id_str:d("CurrentAppID").getAppID(),payload:{msg_payloads:g.filter(Boolean)}},c("CometRelayEnvironment"),e));t(e,"gql_upload_network_request_end");if(i==null){u(e,"gql_upload_failed_response_null",{string:{error:"failed when calling upload message to backup"}});return d("WAResultOrError").makeError("gql_upload_null_response")}g=i==null?void 0:(h=i.xfb_upload_encrypted_msg_to_backup)==null?void 0:h.backup_write_result_response;h=i==null?void 0:(h=i.xfb_upload_encrypted_msg_to_backup)==null?void 0:h.exception_string;if(g==null){var k;u(e,"gql_upload_failed_response_null",{string:{error:(k=h)!=null?k:"unknown server side error"}});d("WALogger").ERROR(j());return d("WAResultOrError").makeError("gql_upload_null_response")}var l=g.is_success,m=g.delete_mailbox,n=(k=g.protobuf_params)==null?void 0:k.delete_on_success;yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;l!=null&&m!=null&&(yield c("LSHandleBackupWriteResultV2StoredProcedure")(c("LSFactory")(a),{deleteMailbox:m,isSuccess:l,protobufParams:n!=null?d("LSShape").ofRecord({delete_on_success:n}):void 0,traceIds:c("LSVec").ofArray(e.map(function(a){return a.traceId}))}));b=i==null?void 0:(b=i.xfb_upload_encrypted_msg_to_backup)==null?void 0:b.device_epoch_status;if(b!=null)switch(b){case"NO_OPEN_EPOCH":t(e,"prepare_open_epoch_v2_start");yield c("LSPrepareOpenEpochV2StoredProcedure")(c("LSFactory")(a),{backupId:void 0});t(e,"prepare_open_epoch_v2_end");break;case"OUTDATED":t(e,"sync_epochs_start");yield c("LSSyncEpochsStoredProcedure")(c("LSFactory")(a));t(e,"sync_epochs_end");break;case"OK":break;default:}});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":315");if(l!=null&&!l){u(e,"gql_upload_failed_in_mutation",{string:{error:(g=h)!=null?g:"unknown server side error"}});return d("WAResultOrError").makeError("gql_upload_failed")}return d("WAResultOrError").makeResult()});return v.apply(this,arguments)}g.mutation=l;g.commitUpload=r;g.uploadMessageOverGQL=a}),98);